# Testing Makefile for OM4labs
# Prior to running, be sure to have installed the package
# by running `pip install .` from the source code directory

# Outputs generated by the package
HEAT_TRANS_PLOTS = heat_transport.png
MOC_PLOTS = moc_rho.png moc_z.png
SECTION_PLOTS = Agulhas.png Barents_Opening.png Bering_Strait.png Davis_Strait.png \
    Denmark_Strait.png Drake_Passage.png English_Channel.png Faroe-Scotland.png \
    Florida-Bahamas.png Fram_Strait.png Gibraltar_Strait.png Iceland-Faroe.png \
    Iceland-Norway.png Indonesian_Throughflow.png Mozambique_Channel.png \
    Pacific_Equatorial_Undercurrent.png Taiwan-Luzon_Strait.png
SFC_BIAS_PLOTS = SSS_diff.png SST_diff.png
THETAO_YZ_PLOTS = thetao_yz_gbl_diff.png thetao_yz_atl_diff.png thetao_yz_pac_diff.png
SO_YZ_PLOTS = so_yz_gbl_diff.png so_yz_atl_diff.png so_yz_pac_diff.png

# Combined set of all plots
COMBINED = $(SECTION_PLOTS) $(SFC_BIAS_PLOTS) $(THETAO_YZ_PLOTS) $(SO_YZ_PLOTS) $(MOC_PLOTS) $(HEAT_TRANS_PLOTS)
IMG = $(patsubst %, output/OM4p25/%, $(COMBINED))

all: $(IMG)

test_data/obs:
	curl -o om4labs.obs_data.latest.tar.gz \
	ftp://ftp.gfdl.noaa.gov/perm/John.Krasting/om4labs/om4labs.obs_data.latest.tar.gz
	tar -xzvf om4labs.obs_data.latest.tar.gz

test_data/OM4p25:
	curl -o om4labs.OM4p25_test_data.latest.tar.gz \
	ftp://ftp.gfdl.noaa.gov/perm/John.Krasting/om4labs/om4labs.OM4p25_test_data.latest.tar.gz
	tar -xzvf om4labs.OM4p25_test_data.latest.tar.gz

$(patsubst %, output/OM4p25/%, $(HEAT_TRANS_PLOTS)): test_data/OM4p25 test_data/obs ../om4labs/diags/heat_transport/heat_transport.py
	om4labs heat_transport --platform testing -o output/OM4p25 \
	-s test_data/OM4p25/pp/ocean_monthly/ocean_monthly.static.nc \
	test_data/OM4p25/pp/ocean_monthly/av/annual_5yr/ocean_monthly.2000-2004.ann.nc

$(patsubst %, output/OM4p25/%, $(MOC_PLOTS)): test_data/OM4p25 ../om4labs/diags/moc/moc.py
	# density plot
	om4labs moc -o output/OM4p25 \
	-s test_data/OM4p25/pp/ocean_annual_rho2/ocean_annual_rho2.static.nc \
	--topog test_data/OM4p25/pp/ocean_annual_rho2/ocean_annual_rho2.static.nc \
	test_data/OM4p25/pp/ocean_annual_rho2/av/annual_5yr/ocean_annual_rho2.2000-2004.ann.nc
	mv output/OM4p25/moc.png output/OM4p25/moc_rho.png
	
	# z-level plot
	om4labs moc -o output/OM4p25 \
	-s test_data/OM4p25/pp/ocean_annual_z/ocean_annual_z.static.nc \
	--topog test_data/OM4p25/pp/ocean_annual_z/ocean_annual_z.static.nc \
	test_data/OM4p25/pp/ocean_annual_z/av/annual_5yr/ocean_annual_z.2000-2004.ann.nc
	mv output/OM4p25/moc.png output/OM4p25/moc_z.png

$(patsubst %, output/OM4p25/%, $(SECTION_PLOTS)): test_data/OM4p25 \
	../om4labs/diags/section_transports/section_transports.py \
	../om4labs/diags/generic_section_transport/generic_section_transport.py 
	om4labs section_transports -o output/OM4p25 test_data/OM4p25/pp

$(patsubst %, output/OM4p25/%, $(SFC_BIAS_PLOTS)): test_data/OM4p25 test_data/obs \
	../om4labs/diags/sst_annual_bias_1x1deg/sst_annual_bias_1x1deg.py \
	../om4labs/diags/sss_annual_bias_1x1deg/sss_annual_bias_1x1deg.py
	om4labs sst_annual_bias_1x1deg --platform testing -o output/OM4p25 \
	test_data/OM4p25/pp/ocean_annual_z_1x1deg/av/annual_5yr/ocean_annual_z_1x1deg.2000-2004.ann.nc
	om4labs sss_annual_bias_1x1deg --platform testing -o output/OM4p25 \
	test_data/OM4p25/pp/ocean_annual_z_1x1deg/av/annual_5yr/ocean_annual_z_1x1deg.2000-2004.ann.nc

$(patsubst %, output/OM4p25/%, $(THETAO_YZ_PLOTS)): test_data/OM4p25 test_data/obs \
	../om4labs/diags/generic_yz_annual_bias_1x1deg/generic_yz_annual_bias_1x1deg.py \
	../om4labs/diags/thetao_yz_annual_bias_1x1deg/thetao_yz_annual_bias_1x1deg.py
	om4labs thetao_yz_annual_bias_1x1deg --style diff --platform testing -o output/OM4p25 \
	--static test_data/OM4p25/pp/ocean_annual_z_1x1deg/ocean_annual_z_1x1deg.static.nc  \
	test_data/OM4p25/pp/ocean_annual_z_1x1deg/av/annual_5yr/ocean_annual_z_1x1deg.2000-2004.ann.nc

$(patsubst %, output/OM4p25/%, $(SO_YZ_PLOTS)): test_data/OM4p25 test_data/obs \
	../om4labs/diags/generic_yz_annual_bias_1x1deg/generic_yz_annual_bias_1x1deg.py \
	../om4labs/diags/so_yz_annual_bias_1x1deg/so_yz_annual_bias_1x1deg.py
	om4labs so_yz_annual_bias_1x1deg --style diff --platform testing -o output/OM4p25 \
	--static test_data/OM4p25/pp/ocean_annual_z_1x1deg/ocean_annual_z_1x1deg.static.nc  \
	test_data/OM4p25/pp/ocean_annual_z_1x1deg/av/annual_5yr/ocean_annual_z_1x1deg.2000-2004.ann.nc

clean:
	rm -f $(IMG)
	rm -f bilinear*.nc

distclean:
	rm -f $(IMG)
	rm -f bilinear*.nc
	rm -fR test_data
	rm -fR output
	rm -f om4labs.obs_data.latest.tar.gz
	rm -f om4labs.OM4p25_test_data.latest.tar.gz
